name: CI/CD - Build & Deploy to EC2 (k3s)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euxo pipefail

            APP_DIR="$HOME/devops-cloud-k8s-flask"
            REPO_URL="https://github.com/kumsat/devops-cloud-k8s-flask.git"

            echo "== WHOAMI / HOME =="
            whoami
            echo "$HOME"

            # Ensure passwordless sudo works
            sudo -n true

            # Ensure git exists
            command -v git >/dev/null 2>&1 || (sudo apt-get update && sudo apt-get install -y git)

            # Clone repo if missing
            if [ ! -d "$APP_DIR/.git" ]; then
              rm -rf "$APP_DIR"
              git clone "$REPO_URL" "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "== Sync latest code =="
            git fetch --prune origin main
            git checkout -f main
            git reset --hard origin/main
            git clean -fdx

            echo "== Check Docker and k3s =="
            sudo docker version
            sudo k3s --version

            echo "== Build Docker image =="
            sudo docker build -t devops-flask:latest -f docker/Dockerfile .

            echo "== Import image into k3s containerd =="
            sudo docker save devops-flask:latest -o /tmp/devops-flask.tar
            sudo k3s ctr images import /tmp/devops-flask.tar

            echo "== Deploy to Kubernetes =="
            sudo k3s kubectl apply -f k8s/ec2/ --validate=false
            sudo k3s kubectl get pods -A

            echo "âœ… Deployment completed"
